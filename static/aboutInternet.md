# 路由器设计基础
## 基础知识
路由器主要是为经过它的每个数据帧寻找一条最佳传输路径，并将该数据有效地传送到目的站点。
直接转发：直接到目的站点
间接转发：通过路由器的中转间接到达目的站点
### 路由器基本概念
1. 跳数：一个分组从源主机到目的主机所要经过的路由器的个数。跳数越小，路径越好，是选择最优路径的一种依据。
2. 带宽：一条链路的传输速率，一般表示为Mb/s
3. 延时：一个分组从其源主机到目的主机所要经历的时间，越短路径越好
4. 负载：单位时间内通过路由器或是线路的通信量
5. 可靠性：用分组传输过程中的误码率来衡量，误码率=传输中的误码/所传输的总码数*100%，是数据传输精确性的指标，越小可靠性越高
6. 开销：传输过程中的耗费，通常与所用链路带宽有关
### 评价依据
1. 算法必须正确、稳定、公平
2. 算法应尽量简单
3. 算法必须能适应网络拓扑和通信量的变化
4. 算法应最佳
### 路由表分类
- 静态路由表  
系统管理员事先设置好，固定目的地址路径列表，更新工作必须由管理员手动修改，一般只用在小型的结构不会经常改变的局域网系统中，或者故障查找的实验网络中。
- 动态路由表  
大型互联网络通常采用，自动运行**动态路由选择协议**，建立路由表。当网络结构变化时，协议会自动更新所有路由器中的路由表。不同规模的网络需要选择不同的动态路由选择协议。
### IP路由选择
两个原则
- 最长前缀匹配：无类域间路由法规定IP地址为网络前缀+主机号，那同一子网中网络前缀越多，主机号越少，寻找目的主机越容易
- 路由表条目尽可能少

比如核心路由器S0端口接入层的子网：156.26.0.0/24, 156.26.1.0/24, 156.26.2.0/24, 156.26.3.0/24合并,前22位相同，所以合并到了156.26.0.0/22；
核心路由器S1端口接入层的子网：156.26.56.0/24, 156.26.57.0/24, 156.26.58.0/24, 156.26.59.0/24合并，前22位相同，所以合并到了156.26.56.0/22  
路由器的路由表，下一步S0：156.26.63.0/28，S1：156.26.63.16/28  
下一步S0：156.26.63.240/30，S1：156.26.63.244/30，与输出接口直连  
有了路由表之后，如果RG接受到目的地址156.26.2.37的分组，路由器就需要寻找一条最佳的匹配路由。它将分组的目的地址与路由表中路由进行比较，网络前缀相同，并且网络前缀长度较长的作为最佳路由
## 自治系统与Internet的路由选择协议
自治系统的基本概念：
Internet采用分层的路由选择协议，并将整个Internet划分为许多较小的自治系统（AS）。  
一个自治系统内的所有网络都属于一个单位，例如一所大学、一个公司、政府的一个部门等。  
一个自治系统最重要的特点是有权决定本系统内应该采用何种路由选择协议  
1. 自治系统内部的路由选择协议：域内路由选择协议（内部网关协议IGP）
   - 路由信息协议RIP
   - 开放最短路径优先协议OSPF
2. 自治系统外部的路由选择协议：域间路由选择协议（外部网关协议EGP）
   - 边界网关协议BGP
## 内部网关协议IGP
- 路由信息协议RIP  
要求路由器周期性地向外发送路由刷新报文，主要内容是由若干（V,D）组成的表。表中V代表矢量，即方向，标识该路由器可达到的目的网络或目的主机；D代表距离，即跳数，其他路由器在收到某路由器的（V, D）报文后，据此按照最短路径原则对各自的路由表进行刷新。
- 开放最短路径优先协议OSPF  
开放：OSPF是所有路由器厂商都支持的协议  
最短路径优先：最短路径算法SPF

和RIP比较，OSPF：
1. OSPF使用分布式链路状态（RIP距离向量路由协议）
2. 链路状态度量主要是指费用、距离、延时、带宽等
3. 链路状态发生变化时用洪泛法向所有路由器发送此信息，而RIP仅向自己相邻的几个路由器交换路由信息
4. 执行OSPF协议的路由器之间频繁地交换链路状态信息，因此所有的路由器最终都能建立一个链路状态数据库，这个数据库实际上是全网的拓扑结构图。而RIP的每个路由器虽然都知道所有的网络的距离以及下一跳路由器，但不知道全网的拓扑结构。
## 最短路径优先协议OSPF
为了适应规模更大的网络，并使更新过程更快，开放最短路径优先协议OSPF将一个自治系统分成若干个更小的范围，叫作区域。每个区域有一个32位的区域标识符，路由器数不超过200个。  
每个自治系统都有一个主干区域，其中的路由器称为主干路由器，所有区域都必须链接到主干区域。从自治系统当中的任何区域出发，经过骨干区域，总是有可能到达该自治系统的任何一个地方。主干区域的内部拓扑结构对外不可见。  
每个连接到两个或多个区域的路由器为区域边界路由器  
内部路由器
自治系统边界路由器  
划分区域将利用洪泛法交换链路状态信息的范围局限在每一个区域内而不是整个自治系统。因此每个区域内部的路由器只知道该区域内的完整拓扑结构而不知道其他区域的网络拓扑结构。
## 外部网关协议BGP
边界网关协议BGP是使用在自治系统之间的一种路由选择协议，由于Internet的规模太大，域间路由选择非常困难。
1. 只考虑最短距离找出路由，需要好的算法，费用和安全不太理想。
2. 只用一般的路由选择算法，那么每个路由器必须维持一个很大的路由状态数据库，计算出最短路由将花费很长时间。同时一条路由经过几个不同自治系统，他们内部路由选择协议不同。这种选择路由方式没有意义。

因此，自治系统的域间路由应当允许使用多种路由选择策略，要考虑安全和经济方面因素。找出较好的路由，而不是最佳路由。

BGP-4